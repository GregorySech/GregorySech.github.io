<!DOCTYPE html>
<html lang="en"  class="theme--light" >

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://gregorysech.github.io/images/apple-touch-icon-144x144.png" />
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://gregorysech.github.io/images/apple-touch-icon-120x120.png" />
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://gregorysech.github.io/images/apple-touch-icon-72x72.png" />
  <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://gregorysech.github.io/images/apple-touch-icon-57x57.png" />
  <link rel="short icon" href="https://gregorysech.github.io/images/favicon.png" type="image/x-icon" />
  <link rel="stylesheet" href="https://gregorysech.github.io/style.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">
  <title>Gregory Sech â€¢ Notes on running GitLab Pipelines locally in a Poetry project</title>
  
  
  
</head>

<body>
  <div id="sidebar" class="animated fadeInDown">
    <div class="logo-title">
      <div class="title">
        <img src=https://gregorysech.github.io/images/logo@2x.png style="width:127px;" alt="logo" />
        <h3><a href="https://gregorysech.github.io/">Gregory Sech</a></h3>
        <div class="description">
          <p>Likes problems and solutions.</p>
        </div>
      </div>
    </div>
    <ul class="social-links"><li><a href="https://github.com/GregorySech" aria-label="Go to Github profile page"><i class="fab fa-github"></i></a></li><li><a href="https://gitlab.com/GregorySech" aria-label="Go to Gitlab profile page"><i class="fab fa-gitlab"></i></a></li><li><a href="https://www.instagram.com/gregorysech" aria-label="Go to Instagram profile page"><i class="fab fa-instagram"></i></a>
      </li><li><a href="https://linkedin.com/in/gregory-sech-2bba64104" aria-label="Go to Linkedin profile page"><i class="fab fa-linkedin"></i></a></li>
      
    </ul>
    <div class="footer">
      
      <span>Designed by </span><a href="https://www.caicai.me">CaiCai</a>
      <div class="by_zola"><a href="https://www.getzola.org/" target="_blank">Proudly published with Zola!</a></div>
      
    </div>
  </div>
  <div id="main">
    <div class="page-top animated fadeInDown">
      <div class="nav">
        
        
        
        
        <li><a  href="https://gregorysech.github.io/">Home</a></li>
        <li><a  href="https://gregorysech.github.io/about/">About</a></li><li><a  href="https://gregorysech.github.io/tags">Tags</a></li><li><a 
            href="https://gregorysech.github.io/archive/">Archive</a></li></div>
      <div class="information">
        <div class="back_btn">
          <a onclick="window.history.go(-1)" ><i
              class="fas fa-chevron-left"></i></a>
        </div>
        
        
          
        
        
        <div id="language-switch">
          <button onclick="showLanguages()" aria-label="show languages"><i class="fas fa-globe"></i></button>
          <div id="languages" style="display: none">
            
            <a onclick="window.location.href='https:&#x2F;&#x2F;gregorysech.github.io&#x2F;it&#x2F;'"> Italiano </a>
            
          </div>
        </div>
        
        <div class="avatar"><img src="https://gregorysech.github.io/images/avatar.jpg"></div>
      </div>
    </div>
    <div class="autopagerize_page_element">
      <div class="content">
        
<article class="post animated fadeInDown">
  <h1><a href="https:&#x2F;&#x2F;gregorysech.github.io&#x2F;notes-gitlab-pipelines-locally-poetry&#x2F;">Notes on running GitLab Pipelines locally in a Poetry project</a></h1>
  
  <div class="post-content"><p>Automating tests on code push is a simple way to ensure that writing new code is not breaking the behaviour of the existing software.
For sure developers will need to put in the time and effort to translate the software requirements in programmatic checks however, their automation reduces the overall time required to assure quality.</p>
<p>The Max Planck Computing and Data Facility (MPCDF) <a href="https://docs.mpcdf.mpg.de/doc/data/gitlab/devop-tutorial.html">published a nice tutorial</a> on their wiki on using <a href="https://docs.gitlab.com/ee/ci/pipelines/">GitLab's Pipelines</a> to automate tests for Python projects using <a href="https://python-poetry.org/">Poetry</a>. </p>
<p>Running automated jobs on your workstation can be a lifesaver. If your organisation does not provide GitLab Runners suitable for the automation you want to implement these notes can help you.
I will show how to create a simple Python project using <code>poetry</code> and set up a local instance of GitLab Runner to automate testing and code formatting.</p>
<h2 id="project-setup">Project Setup</h2>
<p>Create the project using the command: <code>poetry new poetry-cicd-gitlab</code>.</p>
<p>I've changed the project's configuration so that Python's virtual environment would be created in the local directory using: <code>poetry config virtualenvs.in-project true --local</code>. This creates a <code>poetry.toml</code> file containing the local configuration for poetry.</p>
<p>I'm adding a few &quot;dev&quot; dependencies to the project: <a href="https://github.com/psf/black">black</a> and <a href="https://docs.pytest.org/">pytest</a>. </p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">poetry</span><span> add</span><span style="color:#bf616a;"> --group</span><span> dev black pytest
</span></code></pre>
<p><code>black</code> is a code formatter, I like its defaults so it has become my go-to choice for Python projects.
<code>pytest</code> is a framework to test Python applications and libraries.</p>
<p>Create a function to test inside the project's module <code>poetry_cicd_gitlab/__init__.py</code> and test it with a function starting with the <a href="https://docs.pytest.org/en/8.2.x/explanation/goodpractices.html#test-discovery">prefix <code>test</code></a> inside <code>tests/test_add.py</code>.
Like so:</p>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#65737e;"># poetry_cicd_gitlab/__init__.py
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">add</span><span>(</span><span style="color:#bf616a;">a</span><span>, </span><span style="color:#bf616a;">b</span><span>):
</span><span>    </span><span style="color:#b48ead;">return </span><span>a + b
</span></code></pre>
<pre data-lang="python" style="background-color:#2b303b;color:#c0c5ce;" class="language-python "><code class="language-python" data-lang="python"><span style="color:#65737e;"># tests/test_add.py
</span><span style="color:#b48ead;">from </span><span>poetry_cicd_gitlab </span><span style="color:#b48ead;">import </span><span>add
</span><span>
</span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">test_add</span><span>():
</span><span>    </span><span style="color:#b48ead;">assert </span><span style="color:#bf616a;">add</span><span>(</span><span style="color:#d08770;">1</span><span>, </span><span style="color:#d08770;">1</span><span>) == </span><span style="color:#d08770;">2
</span></code></pre>
<p>Running <code>poetry run pytest</code> should collect 1 test and it should pass.
Now we have a mostly empty project with a test and a way to format code automatically when we add code to our project. So let's make a repository on GitLab to store it.</p>
<h1 id="repository-setup">Repository Setup</h1>
<p>At this point go to your designed GitLab instance, create a repository for the project, and push the appropriate code.
Generally, it's a good idea to leave out of version control the <code>__pycache__</code>, <code>.venv</code> and <code>.pytest_cache</code> folders using a <code>.gitignore</code> file.</p>
<p>After pushing the code it's time to prepare our <a href="https://docs.gitlab.com/ee/ci/pipelines/">Pipeline</a>. I strongly recommend following the official <a href="https://docs.gitlab.com/ee/ci/quick_start/">&quot;Tutorial: Create and run your first GitLab CI/CD pipeline&quot;</a> </p>
<p>This <a href="https://docs.gitlab.com/runner/install/docker.html">documentation</a> page describes how to install <code>gitlab-runner</code> using <code>docker</code>. 
This happens in two steps: runner registration and execution.</p>
<p>To register the runner use:</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">docker</span><span> run</span><span style="color:#bf616a;"> --rm -i -t </span><span>\
</span><span style="color:#bf616a;">-v</span><span> ./runner-config:/etc/gitlab-runner \
</span><span style="color:#bf616a;">-v</span><span> /var/run/docker.sock:/var/run/docker.sock \
</span><span>gitlab/gitlab-runner:latest \
</span><span>register</span><span style="color:#bf616a;">  --url </span><span>&lt;gitlab instance url here&gt;  --token &lt;register token here&gt;
</span></code></pre>
<p>The token is provided by the registration procedure found on the repository's CI/CD settings page, in the &quot;Runners&quot; section. </p>
<p>Remember to check &quot;Run untagged jobs&quot; to have this runner run all jobs.</p>
<p><img src="https://gregorysech.github.io/notes-gitlab-pipelines-locally-poetry/2024-07-22_gitlab_new_runner.png" alt="2024-07-22_gitlab_new_runner.png" /></p>
<p>The <code>register</code> command will prompt you with a few questions. When asked for a default image I specified <code>python:3.11</code> because my project runs Python.
Executing the command above will generate a <code>runner-config/config.toml</code> file. This file contains the configuration for the runner that can be edited to fit your needs.</p>
<p>Now the runner can be executed using</p>
<pre data-lang="bash" style="background-color:#2b303b;color:#c0c5ce;" class="language-bash "><code class="language-bash" data-lang="bash"><span style="color:#bf616a;">docker</span><span> run</span><span style="color:#bf616a;"> -d --name</span><span> gitlab-runner</span><span style="color:#bf616a;"> --restart</span><span> always \
</span><span style="color:#bf616a;">  -v</span><span> ./runner-config:/etc/gitlab-runner \
</span><span style="color:#bf616a;">  -v</span><span> /var/run/docker.sock:/var/run/docker.sock \
</span><span>  gitlab/gitlab-runner:latest run
</span></code></pre>
<p>We're ready to get a Pipeline running, we need to write it tho!</p>
<h1 id="writing-the-pipeline">Writing the Pipeline</h1>
<p>The pipeline for this example needs to:</p>
<ol>
<li>Set up poetry. This is fine only in a toy example. Ideally, a container image for the project should be provided to avoid re-downloading all dependencies for every job in the pipeline.</li>
<li>Run all tests and create a report.</li>
<li>Check if the code formatting is good or if black should be run.</li>
</ol>
<p>To set up poetry in the image use the <code>before_script</code> section to run a set of commands before each job execution.</p>
<pre data-lang="yaml" style="background-color:#2b303b;color:#c0c5ce;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#bf616a;">before_script</span><span>:
</span><span>  - </span><span style="color:#a3be8c;">curl -sSL https://install.python-poetry.org | POETRY_HOME=/etc/poetry python3 -
</span><span>  - </span><span style="color:#a3be8c;">export PATH=/etc/poetry/bin:PATH
</span><span>  - </span><span style="color:#a3be8c;">poetry install
</span></code></pre>
<p>The pipeline has only one stage so the <code>.gitlab-ci.yml</code>'s <code>stages</code> property will contain only one element: <code>checks</code>.</p>
<p>The job to check the formatting is quite simple:</p>
<pre data-lang="yaml" style="background-color:#2b303b;color:#c0c5ce;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#bf616a;">job_format</span><span>:
</span><span>  </span><span style="color:#bf616a;">stage</span><span>: </span><span style="color:#a3be8c;">checks
</span><span>  </span><span style="color:#bf616a;">script</span><span>:
</span><span>    - </span><span style="color:#a3be8c;">echo &quot;Checking code formatting&quot;
</span><span>    - </span><span style="color:#a3be8c;">poetry run black . --check
</span></code></pre>
<p>It simply runs <code>black . --check</code> using the version installed by <code>poetry</code>.</p>
<p>The job for <code>pytest</code> is a bit more complex. It has to specify that it creates an artefact: the test report in JUnit format.</p>
<pre data-lang="yaml" style="background-color:#2b303b;color:#c0c5ce;" class="language-yaml "><code class="language-yaml" data-lang="yaml"><span style="color:#bf616a;">job_test</span><span>:
</span><span>  </span><span style="color:#bf616a;">stage</span><span>: </span><span style="color:#a3be8c;">checks
</span><span>  </span><span style="color:#bf616a;">script</span><span>:
</span><span>    - </span><span style="color:#a3be8c;">echo &quot;Running tests&quot;
</span><span>    - </span><span style="color:#a3be8c;">poetry run pytest --junit-xml=report.xml
</span><span>  </span><span style="color:#bf616a;">artifacts</span><span>:
</span><span>    </span><span style="color:#bf616a;">when</span><span>: </span><span style="color:#a3be8c;">always
</span><span>    </span><span style="color:#bf616a;">paths</span><span>:
</span><span>      - </span><span style="color:#a3be8c;">report.xml
</span><span>    </span><span style="color:#bf616a;">reports</span><span>:
</span><span>      </span><span style="color:#bf616a;">junit</span><span>: </span><span style="color:#a3be8c;">report.xml
</span></code></pre>
<p>With this our pipeline is done, you can commit and push the <code>.gitlab-ci.yml</code> file on the repository. GitLab will invoke your instance of <code>gitlab-runner</code>, and execute the scripts you provided.</p>
<h1 id="conclusion">Conclusion</h1>
<p>In these notes, I wanted to simulate what you might need to do if you have to use a GitLab instance that does not have runners for automated testing.
I've created a bare-bone project using <code>poetry</code> and set up a local instance of GitLab Runner to run an automation pipeline. The project can be found in <a href="https://gitlab.com/GregorySech/poetry_cicd_gitlab">this public repository</a>!
Thanks to this automation the repository will automatically check that the code is formatted using <code>black</code> and that <code>pytest</code> tests are run at every commit.
The proposed pipeline should be heavily modified to fit your needs and avoid wasting resources but it's a starting point.</p>
</div>
  <div class="post-footer">
    <div class="meta">
      <div class="info">
        
        <i class="far fa-sun"></i><span class="date">2024-07-22</span>
        
        
        <i class="fas fa-tags"></i>
        
        <a class="tag" href="https://gregorysech.github.io/tags/GitLab">&nbsp;GitLab</a>
        
        <a class="tag" href="https://gregorysech.github.io/tags/Python">&nbsp;Python</a>
        
        <a class="tag" href="https://gregorysech.github.io/tags/Poetry">&nbsp;Poetry</a>
        
        <a class="tag" href="https://gregorysech.github.io/tags/CICD">&nbsp;CICD</a>
        
        <a class="tag" href="https://gregorysech.github.io/tags/Docker">&nbsp;Docker</a>
        
        
      </div>
    </div>
  </div>
</article>
<div class="share">
  <div class="weibo">
    <a class="fab fa-weibo"
      href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&title=',e(d.title),'&appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a>
  </div>
  <div class="twitter">
    <a class="fab fa-twitter"
      href="http://twitter.com/share?text=Notes on running GitLab Pipelines locally in a Poetry project&url=https:&#x2F;&#x2F;gregorysech.github.io&#x2F;notes-gitlab-pipelines-locally-poetry&#x2F;&hashtags=GitLab,Python,Poetry,CICD,Docker"></a>
  </div>
</div>










      </div>
    </div>
  </div>
  
  <script>
    function showLanguages() {
      let currentDisplay = document.getElementById("languages").style.display;
      if (currentDisplay == 'none') {
        document.getElementById("languages").style.display = 'block';
      } else {
        document.getElementById("languages").style.display = 'none';
      }
    }
  </script>
</body>

</html>